<html lang="en">

<head>
    <title>Green roof weather sensors</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        html,
        body,
        h1,
        h2,
        h3,
        h4,
        h5 {
            font-family: "Raleway", sans-serif
        }
    </style>
</head>

<body style="margin:20;padding:0">
    <h1>Green roof weather sensors</h1>
    <form action="#" id="data-input" onsubmit="get_data();">
        <label for="sensor-select">Sensor</label>
        <select id="sensor-select">
            <option value="">--Select a sensor--</option>
            <option value="pressure">pressure</option>
            <option value="power">power</option>
            <option value="rain">rain</option>
            <!-- <option value="sunshine">sunshine</option> -->
            <option value="wind_dir">wind direction</option>
            <option value="wind_speed">wind speed</option>
            <option value="average_humidity">average humidity</option>
            <option value="max_humidity">max humidity</option>
            <option value="min_humidity">min humidity</option>
            <option value="average_temp">average temp</option>
            <option value="max_temp">max temp</option>
            <option value="min_temp">min temp</option>
            <option value="average_total_radiation">average total radiation</option>
            <option value="max_total_radiation">max total radiation</option>
            <option value="min_total_radiation">min total radiation</option>
            <option value="average_diffuse_radiation">average diffuse radiation</option>
            <option value="max_diffuse_radiation">max diffuse radiation</option>
            <option value="min_diffuse_radiation">min diffuse radiation</option>
            <option value="evapotranspiration">evapotranspiration</option>
            <option value="daily_cumulative_evapotranspiration">daily cumulative evapotranspiration</option>
            <option value="daily_total_evapotranspiration">daily total evapotranspiration</option>

        </select>
        <br>
        <br>


        <label for="end-date">End date:</label>
        <select id="start-or-end">
            <option value="end">End date</option>
            <option value="start">Start date</option>
        </select>
        <input type="datetime-local" id="datetime" value="">
        <br>
        <br>
        Duration:
        <input type="number" min="0" max="30" value="0" id="time-days" size="2"> days,
        <input type="number" min="0" max="59" value="0" id="time-hours" size="2"> hours,
        <input type="number" min="0" max="59" value="7" id="time-minutes" size="2"> minutes
        <br>
        <br>
        <input type="submit">
    </form>

    <div class="chart-container" style="position: relative; height:60vh; width:80vw">
        <canvas id="myChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const host = window.location.origin;
        console.log(host);
        const SERVER_URL = origin + "/greenroof/weather/";
        function set_date(id) {
            el = document.getElementById(id);
            const url = origin + "/greenroof/latest-date/weather";
            fetch(url).then((response) => response.json())
                .then((text) => {
                    console.log(text);
                    el.valueAsDate = new Date(Date.parse(text));
                })
        }
        set_date("datetime");
        const ctx = document.getElementById('myChart')
        var chart = new Chart(ctx, {});
        function get_data() {
            const sensor = document.getElementById("sensor-select").value;
            const datetime = document.getElementById("datetime").valueAsDate.toISOString();
            const days = document.getElementById("time-days").value;
            const hours = document.getElementById("time-hours").value;
            const minutes = document.getElementById("time-minutes").value;
            const seconds = 60 * (minutes + 60 * (hours + 24 * days));

            const which_time = document.getElementById("start-or-end").value + "_time"
            const url = SERVER_URL + sensor + "?" + new URLSearchParams(
                {
                    [which_time]: datetime,
                    "duration": seconds,
                }
            );
            fetch(url)
                .then((response) => response.json())
                .then(
                    (data) => {
                        chart.destroy();

                        chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                datasets: [{
                                    data: data[sensor],
                                    label: sensor,
                                    pointRadius: 0,
                                    borderWidth: 1
                                }],
                                labels: data["datetimes"],
                            },
                            options: {
                                xAxes: [{
                                    type: 'time',
                                    distribution: 'linear',
                                    responsive: true,
                                    maintainAspectRatio: true,
                                }]
                            }
                        });
                    });


        }


    </script>


</body>

</html>